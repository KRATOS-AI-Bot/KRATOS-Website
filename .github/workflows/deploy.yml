name: Deploy Static Website to S3

on:
  push:
    branches:
      - main

env:
  AWS_REGION: us-east-1
  TF_WORKING_DIR: terraform/
  WEBSITE_SOURCE_DIR: website/

jobs:
  deploy-infrastructure:
    runs-on: ubuntu-latest
    outputs:
      s3_bucket_name: ${{ steps.terraform-outputs.outputs.s3_bucket_name }}
      website_endpoint: ${{ steps.terraform-outputs.outputs.website_endpoint }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v2
      with:
        terraform_version: 1.6.6 # Specify a stable version

    - name: Terraform Init
      id: init
      run: terraform init
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Validate
      id: validate
      run: terraform validate
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Terraform Apply
      id: apply
      run: terraform apply -auto-approve
      working-directory: ${{ env.TF_WORKING_DIR }}

    - name: Get Terraform Outputs
      id: terraform-outputs
      run: |
        echo "s3_bucket_name=$(terraform output -raw s3_bucket_name)" >> "$GITHUB_OUTPUT"
        echo "website_endpoint=$(terraform output -raw website_endpoint)" >> "$GITHUB_OUTPUT"
      working-directory: ${{ env.TF_WORKING_DIR }}

  sync-website-content:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Configure AWS Credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Sync website files to S3
      run: |
        aws s3 sync "${{ env.WEBSITE_SOURCE_DIR }}" "s3://${{ needs.deploy-infrastructure.outputs.s3_bucket_name }}/" \
          --delete \
          --acl public-read \
          --exclude "*.DS_Store" \
          --exclude "*.git/*"
      env:
        S3_BUCKET_NAME: ${{ needs.deploy-infrastructure.outputs.s3_bucket_name }}